<script>import { createEventDispatcher } from "svelte";
import { Button, Modal } from "..";
import { ChevronLeftOutline, ChevronRightOutline } from "flowbite-svelte-icons";
export let currentDate = /* @__PURE__ */ new Date();
export let open = false;
export let locale = "default";
export let firstDayOfWeek = 0;
export let showToday = true;
export let showClose = true;
export let dateFormat = { month: "long", year: "numeric" };
export let dayLabelFormat = "short";
export let customClass = "";
export let primaryColor = "blue";
export let secondaryColor = "gray";
const dispatch = createEventDispatcher();
let currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
let daysInMonth = getDaysInMonth(currentMonth);
function getDaysInMonth(date) {
  const year = date.getFullYear();
  const month = date.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysArray = [];
  let start = firstDay.getDay() - firstDayOfWeek;
  if (start < 0) start += 7;
  for (let i = 0; i < start; i++) {
    const prevMonthDay = new Date(year, month, -i);
    daysArray.unshift(prevMonthDay);
  }
  for (let i = 1; i <= lastDay.getDate(); i++) {
    daysArray.push(new Date(year, month, i));
  }
  const remainingDays = 7 - daysArray.length % 7;
  if (remainingDays < 7) {
    for (let i = 1; i <= remainingDays; i++) {
      daysArray.push(new Date(year, month + 1, i));
    }
  }
  return daysArray;
}
function changeMonth(increment) {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + increment, 1);
  daysInMonth = getDaysInMonth(currentMonth);
}
function handleDaySelect(day) {
  dispatch("selectDay", day);
  open = false;
}
function isCurrentMonth(day) {
  return day.getMonth() === currentMonth.getMonth();
}
function handleClose() {
  open = false;
  dispatch("close");
}
function goToToday() {
  const today = /* @__PURE__ */ new Date();
  currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  daysInMonth = getDaysInMonth(currentMonth);
  currentDate = today;
  handleDaySelect(today);
}
function isToday(day) {
  const today = /* @__PURE__ */ new Date();
  return day.getDate() === today.getDate() && day.getMonth() === today.getMonth() && day.getFullYear() === today.getFullYear();
}
$: weekdays = [...Array(7)].map((_, i) => {
  const day = new Date(2021, 5, i + firstDayOfWeek);
  return day.toLocaleString(locale, { weekday: dayLabelFormat });
});
export function setDate(date) {
  currentDate = date;
  currentMonth = new Date(date.getFullYear(), date.getMonth(), 1);
  daysInMonth = getDaysInMonth(currentMonth);
}
export function nextMonth() {
  changeMonth(1);
}
export function previousMonth() {
  changeMonth(-1);
}
export function setMonth(month) {
  currentMonth = new Date(currentMonth.getFullYear(), month, 1);
  daysInMonth = getDaysInMonth(currentMonth);
}
export function setYear(year) {
  currentMonth = new Date(year, currentMonth.getMonth(), 1);
  daysInMonth = getDaysInMonth(currentMonth);
}
</script>

<Modal bind:open size="xs" autoclose={false} class={`w-full ${customClass}`}>
	<div class="w-full max-w-md rounded-lg p-6">
		<div class="mb-4 flex items-center justify-between">
			<Button size="sm" on:click={() => changeMonth(-1)} color={primaryColor}>
				<ChevronLeftOutline size="md" />
			</Button>
			<span class="text-lg font-semibold">
				{currentMonth.toLocaleString(locale, dateFormat)}
			</span>
			<Button size="sm" on:click={() => changeMonth(1)} color={primaryColor}>
				<ChevronRightOutline size="md" />
			</Button>
		</div>
		<div class="grid grid-cols-7 gap-2">
			{#each weekdays as day}
				<div class="text-center text-sm font-medium">{day}</div>
			{/each}
			{#each daysInMonth as day}
				<Button
					size="sm"
					color={currentDate.toDateString() === day.toDateString()
						? primaryColor
						: isToday(day)
							? secondaryColor
							: 'alternative'}
					class={!isCurrentMonth(day) ? 'opacity-50' : ''}
					on:click={() => handleDaySelect(day)}
				>
					{day.getDate()}
				</Button>
			{/each}
		</div>
		<div class="mt-4 flex justify-between">
			{#if showToday}
				<Button size="sm" color={primaryColor} on:click={goToToday}>Today</Button>
			{/if}
			{#if showClose}
				<Button size="sm" color={primaryColor} on:click={handleClose}>Close</Button>
			{/if}
		</div>
	</div>
</Modal>

<!--
@component
[Go to docs](https://flowbite-svelte.com/)
## Props
@prop export let currentDate: Date = new Date();
@prop export let open = false;
@prop export let locale: string = 'default';
@prop export let firstDayOfWeek: number = 0;
@prop export let showToday: boolean = true;
@prop export let showClose: boolean = true;
@prop export let dateFormat: Intl.DateTimeFormatOptions = { month: 'long', year: 'numeric' };
@prop export let dayLabelFormat: 'short' | 'narrow' | 'long' = 'short';
@prop export let customClass: string = '';
@prop export let primaryColor: Button['color'] = 'blue';
@prop export let secondaryColor: string = 'gray';
-->
